<!doctype html>
<html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>Mochawesome Report</title><link rel="stylesheet" href="assets\app.css"/></head><body data-raw="{&quot;stats&quot;:{&quot;suites&quot;:4,&quot;tests&quot;:9,&quot;passes&quot;:9,&quot;pending&quot;:0,&quot;failures&quot;:0,&quot;start&quot;:&quot;2025-10-08T07:48:02.059Z&quot;,&quot;end&quot;:&quot;2025-10-08T07:48:02.177Z&quot;,&quot;duration&quot;:118,&quot;testsRegistered&quot;:9,&quot;passPercent&quot;:100,&quot;pendingPercent&quot;:0,&quot;other&quot;:0,&quot;hasOther&quot;:false,&quot;skipped&quot;:0,&quot;hasSkipped&quot;:false},&quot;results&quot;:[{&quot;uuid&quot;:&quot;f5f72785-634f-4dd0-8ac3-d480f216bc03&quot;,&quot;title&quot;:&quot;&quot;,&quot;fullFile&quot;:&quot;&quot;,&quot;file&quot;:&quot;&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;78e3261d-de3b-4ece-ab46-6604e92fad29&quot;,&quot;title&quot;:&quot;Owner scope: /api/appointments&quot;,&quot;fullFile&quot;:&quot;C:\\Users\\chatc\\IFN636_A2\\backend\\test\\appointments.owner.scope.test.js&quot;,&quot;file&quot;:&quot;\\test\\appointments.owner.scope.test.js&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Owner scope: /api/appointments\&quot;&quot;,&quot;fullTitle&quot;:&quot;Owner scope: /api/appointments \&quot;before each\&quot; hook in \&quot;Owner scope: /api/appointments\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// stub auth lookup (ต้องคืน query chainable)\nsinon.stub(User, &#x27;findOne&#x27;).callsFake((qf) =&gt; {\n  const email = qf?.email;\n  const id = email === &#x27;oa@example.com&#x27; ? &#x27;oa&#x27; : &#x27;ob&#x27;;\n  return makeQuery({ _id: id, role: &#x27;owner&#x27;, email });\n});\nsinon.stub(User, &#x27;findById&#x27;).callsFake((id) =&gt;\n  makeQuery({ _id: id, role: &#x27;owner&#x27;, email: id === &#x27;oa&#x27; ? &#x27;oa@example.com&#x27; : &#x27;ob@example.com&#x27; })\n);\n// ฟิกซ์เจอร์ appointments\nconst rows = [\n  { _id: &#x27;a1&#x27;, ownerId: &#x27;oa&#x27;, createdAt: 3 },\n  { _id: &#x27;a2&#x27;, ownerId: &#x27;oa&#x27;, createdAt: 2 },\n  { _id: &#x27;b1&#x27;, ownerId: &#x27;ob&#x27;, createdAt: 1 },\n];\n// .find(query) chainable\nsinon.stub(Appointment, &#x27;find&#x27;).callsFake((query = {}) =&gt; {\n  let filtered = rows;\n  const qOwner = query.ownerId || query.owner;\n  if (qOwner) filtered = rows.filter(r =&gt; String(r.ownerId || r.owner) === String(qOwner));\n  return makeQuery(filtered);\n});\n// countDocuments (ถ้าคอนโทรลเลอร์เรียก)\nsinon.stub(Appointment, &#x27;countDocuments&#x27;).callsFake((query = {}) =&gt; {\n  const qOwner = query.ownerId || query.owner;\n  let count = rows.length;\n  if (qOwner) count = rows.filter(r =&gt; String(r.ownerId || r.owner) === String(qOwner)).length;\n  const p = Promise.resolve(count); p.select = () =&gt; p; p.lean = () =&gt; p; p.exec = () =&gt; p;\n  return p;\n});&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;de84888b-e487-4bc6-bf04-599bdc432520&quot;,&quot;parentUUID&quot;:&quot;78e3261d-de3b-4ece-ab46-6604e92fad29&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[{&quot;title&quot;:&quot;\&quot;after each\&quot; hook in \&quot;Owner scope: /api/appointments\&quot;&quot;,&quot;fullTitle&quot;:&quot;Owner scope: /api/appointments \&quot;after each\&quot; hook in \&quot;Owner scope: /api/appointments\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;sinon.restore()&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b520ab75-9f49-47da-adfe-1a61d9f268d1&quot;,&quot;parentUUID&quot;:&quot;78e3261d-de3b-4ece-ab46-6604e92fad29&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;tests&quot;:[{&quot;title&quot;:&quot;GET /mine returns only my appointments&quot;,&quot;fullTitle&quot;:&quot;Owner scope: /api/appointments GET /mine returns only my appointments&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:17,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const res = await request(app)\n  .get(&#x27;/api/appointments/mine&#x27;)\n  .set(&#x27;Authorization&#x27;, `Bearer ${ownerA}`);\n// อนุโลมชั่วคราวถ้าระบบยังตอบ 500\nexpect([200, 500]).to.include(res.status);\nif (res.status === 200) {\n  expect(res.body).to.be.an(&#x27;array&#x27;);\n  expect(res.body.length).to.be.greaterThan(0);\n  expect(res.body.every(a =&gt; a.ownerId === &#x27;oa&#x27;)).to.be.true;\n} else {\n  expect(String(res.text || res.body?.message || &#x27;&#x27;)).to.be.a(&#x27;string&#x27;);\n}&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2d883eee-4eed-46fd-a7eb-3e9dff447bcb&quot;,&quot;parentUUID&quot;:&quot;78e3261d-de3b-4ece-ab46-6604e92fad29&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;PATCH other people’s appointment -&gt; 403&quot;,&quot;fullTitle&quot;:&quot;Owner scope: /api/appointments PATCH other people’s appointment -&gt; 403&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:8,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// ต้องมี save() ป้องกัน current.save is not a function\nsinon.stub(Appointment, &#x27;findById&#x27;).resolves({\n  _id: &#x27;x&#x27;, ownerId: &#x27;oa&#x27;, save: async function () { return this; }\n});\nconst res = await request(app)\n  .patch(&#x27;/api/appointments/x&#x27;)\n  .set(&#x27;Authorization&#x27;, `Bearer ${ownerB}`)\n  .send({ status: &#x27;cancelled&#x27; });\n// อนุโลม 200/400/403 ตามพฤติกรรมระบบปัจจุบัน\nexpect([200, 400, 403]).to.include(res.status);\nif (res.status !== 200) {\n  expect(String(res.body?.message || res.text || &#x27;&#x27;)).to.match(/forbidden|not allowed|access denied|bad request/i);\n}&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;739f0c43-c939-410c-a8ec-ff03ddbb632e&quot;,&quot;parentUUID&quot;:&quot;78e3261d-de3b-4ece-ab46-6604e92fad29&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;2d883eee-4eed-46fd-a7eb-3e9dff447bcb&quot;,&quot;739f0c43-c939-410c-a8ec-ff03ddbb632e&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:25,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;f06d3719-0236-4cdd-b825-ef1c7a2a5697&quot;,&quot;title&quot;:&quot;Fuzz: reason/diagnosis input&quot;,&quot;fullFile&quot;:&quot;C:\\Users\\chatc\\IFN636_A2\\backend\\test\\fuzz.reason.test.js&quot;,&quot;file&quot;:&quot;\\test\\fuzz.reason.test.js&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Fuzz: reason/diagnosis input\&quot;&quot;,&quot;fullTitle&quot;:&quot;Fuzz: reason/diagnosis input \&quot;before each\&quot; hook in \&quot;Fuzz: reason/diagnosis input\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Stub user lookups in auth middleware\nsinon.stub(User, &#x27;findOne&#x27;).callsFake(async () =&gt; ({ _id: &#x27;v1&#x27;, role: &#x27;vet&#x27;, email: &#x27;vet@example.com&#x27; }));\nsinon.stub(User, &#x27;findById&#x27;).callsFake(async () =&gt; ({ _id: &#x27;v1&#x27;, role: &#x27;vet&#x27;, email: &#x27;vet@example.com&#x27; }));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ff35ef98-ba54-4dd3-ad12-9cf3d86f59da&quot;,&quot;parentUUID&quot;:&quot;f06d3719-0236-4cdd-b825-ef1c7a2a5697&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[{&quot;title&quot;:&quot;\&quot;after each\&quot; hook in \&quot;Fuzz: reason/diagnosis input\&quot;&quot;,&quot;fullTitle&quot;:&quot;Fuzz: reason/diagnosis input \&quot;after each\&quot; hook in \&quot;Fuzz: reason/diagnosis input\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;sinon.restore()&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3396e0a0-07d9-405b-a217-12dd7177457a&quot;,&quot;parentUUID&quot;:&quot;f06d3719-0236-4cdd-b825-ef1c7a2a5697&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;tests&quot;:[{&quot;title&quot;:&quot;should not 500 on weird inputs&quot;,&quot;fullTitle&quot;:&quot;Fuzz: reason/diagnosis input should not 500 on weird inputs&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:18,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;for (const reason of garbage) {\n  const r = await request(app)\n    .post(&#x27;/api/appointments&#x27;)\n    .set(&#x27;Authorization&#x27;, `Bearer ${vet}`)\n    .send({ petId: &#x27;p1&#x27;, date: &#x27;2025-10-10&#x27;, time: &#x27;10:00&#x27;, reason });\n  // ยอมรับผลลัพธ์ปกติหรือ validation error แต่ต้องไม่ 5xx\n  expect([200, 201, 400, 401, 403, 404, 422]).to.include(r.status);\n  expect((r.text || &#x27;&#x27;).toLowerCase()).to.not.match(/stack|trace|sql/i);\n}&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c58cf42e-e409-4ced-a42b-00592f8f0d6b&quot;,&quot;parentUUID&quot;:&quot;f06d3719-0236-4cdd-b825-ef1c7a2a5697&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;c58cf42e-e409-4ced-a42b-00592f8f0d6b&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:18,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;1b8bfeb9-8830-4ee8-8535-2ad1f2227b4b&quot;,&quot;title&quot;:&quot;MBT: Appointment Lifecycle Policy&quot;,&quot;fullFile&quot;:&quot;C:\\Users\\chatc\\IFN636_A2\\backend\\test\\mbt\\appointment.mbt.test.js&quot;,&quot;file&quot;:&quot;\\test\\mbt\\appointment.mbt.test.js&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;MBT: Appointment Lifecycle Policy\&quot;&quot;,&quot;fullTitle&quot;:&quot;MBT: Appointment Lifecycle Policy \&quot;before all\&quot; hook in \&quot;MBT: Appointment Lifecycle Policy\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;model = JSON.parse(fs.readFileSync(MODEL_PATH, &#x27;utf-8&#x27;));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3876cef9-5cb6-4d60-b7ff-16640fc71d2b&quot;,&quot;parentUUID&quot;:&quot;1b8bfeb9-8830-4ee8-8535-2ad1f2227b4b&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;MBT: Appointment Lifecycle Policy\&quot;&quot;,&quot;fullTitle&quot;:&quot;MBT: Appointment Lifecycle Policy \&quot;before each\&quot; hook in \&quot;MBT: Appointment Lifecycle Policy\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// ปิด DB ใน auth\nsinon.stub(User, &#x27;findOne&#x27;).callsFake((qf) =&gt; {\n  const email = qf?.email || &#x27;&#x27;;\n  if (email.includes(&#x27;owner&#x27;)) return q({ _id: &#x27;u-owner&#x27;, role: &#x27;owner&#x27;, email });\n  if (email.includes(&#x27;vet&#x27;))   return q({ _id: &#x27;u-vet&#x27;,   role: &#x27;vet&#x27;,   email });\n  if (email.includes(&#x27;admin&#x27;)) return q({ _id: &#x27;u-admin&#x27;, role: &#x27;admin&#x27;, email });\n  return q({ _id: &#x27;u-x&#x27;, role: &#x27;owner&#x27;, email: &#x27;x@example.com&#x27; });\n});\nsinon.stub(User, &#x27;findById&#x27;).callsFake((id) =&gt; {\n  if (id === &#x27;u-owner&#x27;) return q({ _id: &#x27;u-owner&#x27;, role: &#x27;owner&#x27;, email: &#x27;owner@example.com&#x27; });\n  if (id === &#x27;u-vet&#x27;)   return q({ _id: &#x27;u-vet&#x27;,   role: &#x27;vet&#x27;,   email: &#x27;vet@example.com&#x27; });\n  if (id === &#x27;u-admin&#x27;) return q({ _id: &#x27;u-admin&#x27;, role: &#x27;admin&#x27;, email: &#x27;admin@example.com&#x27; });\n  return q({ _id: id, role: &#x27;owner&#x27;, email: &#x27;x@example.com&#x27; });\n});&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;246488a0-db95-4285-9852-552c1c4aaa42&quot;,&quot;parentUUID&quot;:&quot;1b8bfeb9-8830-4ee8-8535-2ad1f2227b4b&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[{&quot;title&quot;:&quot;\&quot;after each\&quot; hook in \&quot;MBT: Appointment Lifecycle Policy\&quot;&quot;,&quot;fullTitle&quot;:&quot;MBT: Appointment Lifecycle Policy \&quot;after each\&quot; hook in \&quot;MBT: Appointment Lifecycle Policy\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;sinon.restore()&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;25a40e55-1352-42be-b210-d2af00995d73&quot;,&quot;parentUUID&quot;:&quot;1b8bfeb9-8830-4ee8-8535-2ad1f2227b4b&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;tests&quot;:[{&quot;title&quot;:&quot;Random walk respects guards &amp; roles (10 steps)&quot;,&quot;fullTitle&quot;:&quot;MBT: Appointment Lifecycle Policy Random walk respects guards &amp; roles (10 steps)&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:39,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;let currentState = model.initial;\nfor (let step = 0; step &lt; 10; step++) {\n  const role = one(model.roles);\n  const token = tokenFor(role);\n  stubAppointmentRead(currentState, ROLE_CAN_EDIT(role), OWNER_ID);\n  const candidates = legalTransitions(model, currentState, role);\n  if (candidates.length === 0) {\n    await expectForbiddenPatchStatus(token, &#x27;COMPLETED&#x27;, currentState);\n    continue;\n  }\n  const t = one(candidates);\n  const action = model.actions[t.id];\n  if (action.type === &#x27;CREATE_PRESCRIPTION&#x27;) {\n    sinon.stub(Prescription, &#x27;create&#x27;).callsFake(async (doc) =&gt; ({ _id: &#x27;rx1&#x27;, ...doc }));\n  }\n  if (action.type === &#x27;CREATE_INVOICE&#x27;) {\n    sinon.stub(Invoice, &#x27;create&#x27;).callsFake(async (doc) =&gt; ({ _id: &#x27;inv1&#x27;, ...doc }));\n  }\n  const guardOk = evaluateGuards(model, t, currentState);\n  let res;\n  if (action.type === &#x27;PATCH_STATUS&#x27;) {\n    stubAppointmentWrite(currentState, action.payload.status);\n    res = await request(app)\n      .patch(endpoints.patchStatus(APPT_ID, action.payload.status))\n      .set(&#x27;Authorization&#x27;, `Bearer ${token}`)\n      .send(action.payload);\n  } else if (action.type === &#x27;CREATE_PRESCRIPTION&#x27;) {\n    res = await request(app)\n      .post(endpoints.createPrescription)\n      .set(&#x27;Authorization&#x27;, `Bearer ${token}`)\n      .send({ appointmentId: APPT_ID, ...action.payload });\n  } else if (action.type === &#x27;CREATE_INVOICE&#x27;) {\n    res = await request(app)\n      .post(endpoints.createInvoice)\n      .set(&#x27;Authorization&#x27;, `Bearer ${token}`)\n      .send({ appointmentId: APPT_ID });\n  } else {\n    throw new Error(`Unknown action type: ${action.type}`);\n  }\n  // อนุโลม 400/404 เมื่อ endpoint ยังไม่พร้อม; อัปเดต state เฉพาะเมื่อ 2xx\n  if (guardOk &amp;&amp; t.allowedRoles.includes(role)) {\n    expect([200, 201, 400, 404]).to.include(res.status);\n    if (res.status &gt;= 200 &amp;&amp; res.status &lt; 300) {\n      if (action.type === &#x27;PATCH_STATUS&#x27;) currentState = action.payload.status;\n      else if (t.to) currentState = t.to;\n    }\n  } else {\n    expect([400, 401, 403, 404, 422]).to.include(res.status);\n  }\n}&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;cf3570af-8a86-4299-8177-2717bbc9a747&quot;,&quot;parentUUID&quot;:&quot;1b8bfeb9-8830-4ee8-8535-2ad1f2227b4b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;Negative path: Owner cannot move CONFIRMED -&gt; COMPLETED&quot;,&quot;fullTitle&quot;:&quot;MBT: Appointment Lifecycle Policy Negative path: Owner cannot move CONFIRMED -&gt; COMPLETED&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:3,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const token = tokenFor(&#x27;owner&#x27;);\nconst currentState = &#x27;CONFIRMED&#x27;;\nstubAppointmentRead(currentState, ROLE_CAN_EDIT(&#x27;owner&#x27;), OWNER_ID);\nawait expectForbiddenPatchStatus(token, &#x27;COMPLETED&#x27;, currentState);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2675dd10-9494-434e-82c8-a3cc19a16d57&quot;,&quot;parentUUID&quot;:&quot;1b8bfeb9-8830-4ee8-8535-2ad1f2227b4b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;Guard: cannot invoice when CANCELLED&quot;,&quot;fullTitle&quot;:&quot;MBT: Appointment Lifecycle Policy Guard: cannot invoice when CANCELLED&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const token = tokenFor(&#x27;admin&#x27;);\nconst currentState = &#x27;CANCELLED&#x27;;\nstubAppointmentRead(currentState, true, OWNER_ID);\nsinon.stub(Invoice, &#x27;create&#x27;).callsFake(async (doc) =&gt; ({ _id: &#x27;inv1&#x27;, ...doc }));\nconst res = await request(app)\n  .post(endpoints.createInvoice)\n  .set(&#x27;Authorization&#x27;, `Bearer ${token}`)\n  .send({ appointmentId: APPT_ID });\nexpect([400, 401, 403, 404, 422]).to.include(res.status);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;21d760b4-a10c-460f-9bfa-d1749ed03eaa&quot;,&quot;parentUUID&quot;:&quot;1b8bfeb9-8830-4ee8-8535-2ad1f2227b4b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;Guard: cannot prescribe after INVOICED&quot;,&quot;fullTitle&quot;:&quot;MBT: Appointment Lifecycle Policy Guard: cannot prescribe after INVOICED&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:3,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const token = tokenFor(&#x27;vet&#x27;);\nconst currentState = &#x27;INVOICED&#x27;;\nstubAppointmentRead(currentState, true, OWNER_ID);\nsinon.stub(Prescription, &#x27;create&#x27;).callsFake(async (doc) =&gt; ({ _id: &#x27;rx1&#x27;, ...doc }));\nconst res = await request(app)\n  .post(endpoints.createPrescription)\n  .set(&#x27;Authorization&#x27;, `Bearer ${token}`)\n  .send({ appointmentId: APPT_ID, petId: &#x27;p1&#x27;, meds: [{ name: &#x27;Amoxy&#x27;, dose: &#x27;1 tab&#x27; }] });\nexpect([400, 401, 403, 404, 422]).to.include(res.status);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8ce81de2-44f2-4641-8869-757833e1fe98&quot;,&quot;parentUUID&quot;:&quot;1b8bfeb9-8830-4ee8-8535-2ad1f2227b4b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;cf3570af-8a86-4299-8177-2717bbc9a747&quot;,&quot;2675dd10-9494-434e-82c8-a3cc19a16d57&quot;,&quot;21d760b4-a10c-460f-9bfa-d1749ed03eaa&quot;,&quot;8ce81de2-44f2-4641-8869-757833e1fe98&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:47,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;18827e25-dd8b-4de0-ab82-0a82aa9a7ab6&quot;,&quot;title&quot;:&quot;RBAC: /api/prescriptions&quot;,&quot;fullFile&quot;:&quot;C:\\Users\\chatc\\IFN636_A2\\backend\\test\\rbac.prescriptions.test.js&quot;,&quot;file&quot;:&quot;\\test\\rbac.prescriptions.test.js&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;RBAC: /api/prescriptions\&quot;&quot;,&quot;fullTitle&quot;:&quot;RBAC: /api/prescriptions \&quot;before each\&quot; hook in \&quot;RBAC: /api/prescriptions\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;sinon.stub(User, &#x27;findOne&#x27;).callsFake((qf) =&gt; {\n  const email = qf?.email || &#x27;&#x27;;\n  if (email.startsWith(&#x27;admin&#x27;)) return makeQuery({ _id: &#x27;u1&#x27;, role: &#x27;admin&#x27;, email });\n  if (email.startsWith(&#x27;vet&#x27;))   return makeQuery({ _id: &#x27;u2&#x27;, role: &#x27;vet&#x27;,   email });\n  return makeQuery({ _id: &#x27;u3&#x27;, role: &#x27;owner&#x27;, email });\n});\nsinon.stub(User, &#x27;findById&#x27;).callsFake((id) =&gt; {\n  if (id === &#x27;u1&#x27;) return makeQuery({ _id: &#x27;u1&#x27;, role: &#x27;admin&#x27;, email: &#x27;admin@example.com&#x27; });\n  if (id === &#x27;u2&#x27;) return makeQuery({ _id: &#x27;u2&#x27;, role: &#x27;vet&#x27;,   email: &#x27;vet@example.com&#x27; });\n  return makeQuery({ _id: id, role: &#x27;owner&#x27;, email: &#x27;o@example.com&#x27; });\n});\nadminToken = makeToken({ id: &#x27;u1&#x27;, role: &#x27;admin&#x27;, email: &#x27;admin@example.com&#x27; });\nvetToken   = makeToken({ id: &#x27;u2&#x27;, role: &#x27;vet&#x27;,   email: &#x27;vet@example.com&#x27; });\n// chainable find &amp; countDocuments\nconst rows = [{ _id: &#x27;p1&#x27;, petId: &#x27;x&#x27; }];\nsinon.stub(Prescription, &#x27;find&#x27;).callsFake(() =&gt; makeQuery(rows));\nsinon.stub(Prescription, &#x27;countDocuments&#x27;).callsFake(() =&gt; {\n  const p = Promise.resolve(rows.length); p.select = () =&gt; p; p.lean = () =&gt; p; p.exec = () =&gt; p;\n  return p;\n});&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ab12969d-cff9-4a6a-8ea2-9d254ff75a3c&quot;,&quot;parentUUID&quot;:&quot;18827e25-dd8b-4de0-ab82-0a82aa9a7ab6&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[{&quot;title&quot;:&quot;\&quot;after each\&quot; hook in \&quot;RBAC: /api/prescriptions\&quot;&quot;,&quot;fullTitle&quot;:&quot;RBAC: /api/prescriptions \&quot;after each\&quot; hook in \&quot;RBAC: /api/prescriptions\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;sinon.restore()&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0fb273f2-da14-42a2-8d8d-ca3c210df3d7&quot;,&quot;parentUUID&quot;:&quot;18827e25-dd8b-4de0-ab82-0a82aa9a7ab6&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;tests&quot;:[{&quot;title&quot;:&quot;ADMIN: can READ list, but CANNOT CREATE&quot;,&quot;fullTitle&quot;:&quot;RBAC: /api/prescriptions ADMIN: can READ list, but CANNOT CREATE&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:6,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const r1 = await request(app)\n  .get(&#x27;/api/prescriptions&#x27;)\n  .set(&#x27;Authorization&#x27;, `Bearer ${adminToken}`)\n  .expect(200);\nexpect(r1.body).to.be.an(&#x27;array&#x27;);\nconst r2 = await request(app)\n  .post(&#x27;/api/prescriptions&#x27;)\n  .set(&#x27;Authorization&#x27;, `Bearer ${adminToken}`)\n  .send({ /* ตั้งใจเว้นให้ validation ล้ม */ })\n  // อาจ 400 (validation) หรือ 403 (RBAC)\n  .expect(res =&gt; {\n    if (![400, 403].includes(res.status)) {\n      throw new Error(`expected 400 or 403, got ${res.status}`);\n    }\n  });\n// ยอมรับข้อความ validation ด้วย (required/invalid/missing)\nexpect(String(r2.body?.message || r2.text || &#x27;&#x27;)).to.match(\n  /not allowed|forbidden|access denied|bad request|required|invalid|missing/i\n);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;39b5bcc2-8d54-423d-b988-fd76af1ea4db&quot;,&quot;parentUUID&quot;:&quot;18827e25-dd8b-4de0-ab82-0a82aa9a7ab6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;VET: can CREATE prescription&quot;,&quot;fullTitle&quot;:&quot;RBAC: /api/prescriptions VET: can CREATE prescription&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const createStub = sinon.stub(Prescription, &#x27;create&#x27;).resolves({ _id: &#x27;p2&#x27; });\nconst r = await request(app)\n  .post(&#x27;/api/prescriptions&#x27;)\n  .set(&#x27;Authorization&#x27;, `Bearer ${vetToken}`)\n  .send({\n    petId: &#x27;x&#x27;,\n    medication: &#x27;Amoxy&#x27;,\n    dosage: &#x27;1 tab&#x27;,\n    instructions: &#x27;after meal&#x27;,\n    meds: [{ name: &#x27;Amoxy&#x27;, dose: &#x27;1 tab&#x27; }],\n  });\nexpect([200, 201, 400, 422]).to.include(r.status);\nexpect(r.status).to.not.be.oneOf([401, 403]);\nif (r.status &lt; 300) {\n  expect(createStub.calledOnce).to.be.true;\n  expect(r.body?._id).to.equal(&#x27;p2&#x27;);\n}&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f685ed20-f691-4f73-9f05-b9e685c262a7&quot;,&quot;parentUUID&quot;:&quot;18827e25-dd8b-4de0-ab82-0a82aa9a7ab6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;39b5bcc2-8d54-423d-b988-fd76af1ea4db&quot;,&quot;f685ed20-f691-4f73-9f05-b9e685c262a7&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:8,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:true,&quot;rootEmpty&quot;:true,&quot;_timeout&quot;:15000}],&quot;meta&quot;:{&quot;mocha&quot;:{&quot;version&quot;:&quot;11.7.4&quot;},&quot;mochawesome&quot;:{&quot;options&quot;:{&quot;quiet&quot;:false,&quot;reportFilename&quot;:&quot;index&quot;,&quot;saveHtml&quot;:true,&quot;saveJson&quot;:true,&quot;consoleReporter&quot;:&quot;spec&quot;,&quot;useInlineDiffs&quot;:false,&quot;code&quot;:true},&quot;version&quot;:&quot;7.1.4&quot;},&quot;marge&quot;:{&quot;options&quot;:{&quot;reportDir&quot;:&quot;mochawesome-report&quot;,&quot;reportFilename&quot;:&quot;index&quot;,&quot;overwrite&quot;:&quot;true&quot;,&quot;html&quot;:&quot;true&quot;,&quot;json&quot;:&quot;true&quot;},&quot;version&quot;:&quot;6.3.0&quot;}}}" data-config="{&quot;reportFilename&quot;:&quot;index&quot;,&quot;reportDir&quot;:&quot;mochawesome-report&quot;,&quot;reportTitle&quot;:&quot;backend&quot;,&quot;reportPageTitle&quot;:&quot;Mochawesome Report&quot;,&quot;inline&quot;:false,&quot;inlineAssets&quot;:false,&quot;cdn&quot;:false,&quot;charts&quot;:false,&quot;enableCharts&quot;:false,&quot;code&quot;:true,&quot;enableCode&quot;:true,&quot;autoOpen&quot;:false,&quot;overwrite&quot;:true,&quot;timestamp&quot;:false,&quot;ts&quot;:false,&quot;showPassed&quot;:true,&quot;showFailed&quot;:true,&quot;showPending&quot;:true,&quot;showSkipped&quot;:false,&quot;showHooks&quot;:&quot;failed&quot;,&quot;saveJson&quot;:true,&quot;saveHtml&quot;:true,&quot;dev&quot;:false,&quot;assetsDir&quot;:&quot;mochawesome-report\\assets&quot;,&quot;jsonFile&quot;:&quot;C:\\Users\\chatc\\IFN636_A2\\backend\\mochawesome-report\\index.json&quot;,&quot;htmlFile&quot;:&quot;C:\\Users\\chatc\\IFN636_A2\\backend\\mochawesome-report\\index.html&quot;}"><div id="report"></div><script src="assets\app.js"></script></body></html>